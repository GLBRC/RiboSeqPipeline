# RiboSeqPipeline

This script is designed to process fastQ files generated by ribosome sequencing,
using the Ezra-seq protocol outlined in Mao et al. Nat Struct Mol Biol. 2023;30(11):1816-1825.
This script takes as input fastQ files from Ezra-seq, trims reads as outlined in 
Escalante et al. 2025, and scores the 5’ position of each read. The ribosomal P site
is taken to be at 12 nt into the read according to Mao et al. The output of this
script includes a space-delimited file of read counts for each gene, where read
starts were summed for each position from -72 of the gene ATG and + 60 of each
stop codon. Output of this script is normalized using NormalizeRiboSeq_GeneVectors_forPub.pl,
see README for details.


## Getting started

    Pipeline is designed to be run using a HTCondor compute cluster.
    After logging into compute cluster activate the riboSeq conda environment.

    conda activate riboSeq

    Please run this pipeline in a dedicated directory and create a subdirectory
    called fastq. Put all of your Read 1 (fwd) fastq files in this directory.
    If fastq files are .gz, decompress them. Create a text file containing the
    fastq names.  This file will be used to run the pipeline.

    ls fastq > fastqFiles.txt

    MyProject/ -> fastq/*R1.fastq

    Paths in files which you will have to change: 
    1) conda env in RiboSeqPipeline.py file.
    
    2) reference genome sizes and reference bed in CountRiboStarts.py.
    
    3) GFF file path in CreateGeneBed.py 
    

## Running the Pipeline

    RiboSeqPipeline.py -f fastqFiles.txt

## Results
    The following directories will be created:
    
    alignments  -- alignment to reference genome results (.sam files)

    alignNonCodingRNA -- filtering step, alignment of intial fastq to Non-Coding RNA.

    condor    -- condor files

    cutadapt  -- fastq files filtered with cutadapt and have additionally had the 1st base
                removed if quality score <= 10.

    log       -- log files for each step

    results   -- contain the count tables for each sample.

 ## Requirements

    See RiboSeq_condaEnv.yml

    Pipeline designed to run as HTCondor Dagman job.

    A bowtie2 built reference genome.  See RiboSeqPipeline.py to change reference location.

 ## Build conda environment

    conda env create -f RiboSeq_condaEnv.yml

 ## List of scripts for pipeline

    cleanUp.py  

    CountRiboStarts.py  

    CreateGeneBed.py  

    removeFirstBase.py  

    RiboSeqPipeline.py  

    runFastqc.py

## Post pipeline script

    NormalizeRiboSeq_GeneVectors_forPub.pl  -- a standalone perl script that takes as input 
    the output of PIPELINE and returns three files of normalize data. The input to script 
    includes is a space-delimited file generated by PIPELINE and desired save file name.
    An example input file ("Escalante-TestInput_NormalizeRiboSeq_GeneVectors.txt”) is provided.  

    Usage:

    > perl NormalizeRiboSeq_GeneVectors_forPub.pl    Escalante-TestInput_NormalizeRiboSeq_GeneVectors.txt      MyOutputFileName

    MyOutputFileName_Pseudcount-Norm_CodonCounts.txt is the data output used for analysis in the paper.
    See comments within for a complete description of the code.”    


*******************************************************************************


## Preliminary pipeline for development and testing using Jupyter Notebook (do not use.)

Designed used with MicroSoft VS Code and to be used with on GLBRC scarcity with HTCondor.  

1) Download VS Code : https://code.visualstudio.com

2) Make sure you have an OpenSSH compatible SSH Client installed locally. On MacOS this should be already be installed.

3) In VS Code install the Remote-SSH extension. If you plan to work with other remote extensions in VS Code, you may choose to install the Remote Development extension pack.

4) In VS Code, select Remote-SSH: Connect to Host... from the Command Palette (F1, Ctrl+Shift+P) and use your user@hostname.

    If you have trouble with the above instructions take a look here: https://code.visualstudio.com/docs/remote/ssh
    for more details on how to get remote ssh development with VS Code started.

6) Open the folder you want to use.  I recommend using git to clone this repository. 
    git clone git@gitpub.wei.wisc.edu:mplace/riboSeqPipeline.git

7) Set up your input fastq files within a subdirectory called "data".

8) Try to use my riboSeq conda environment in VS Code.

 If this doesn't work used conda to create your own conda riboSeq environment.
 Use this file: RiboSeq_condaEnv.yml  located in the git repo.

 Edit the last line in the yml file to reflect your directory.
 prefix: /home/glbrc.org/USER/.conda/envs/riboSeq

 Then to create the environment:  conda create -f RiboSeq_condaEnv.yml
 This can then be used within your VS Code. 

 9) Open RiboSeq_pipeline.ipynb and walk through the pipeline.
 Note that most steps will create condor submit files along with a shell script.
 Just use scarcity-submit.glbrc.org and run condor_submit mySubmit.txt and wait for 
 the job to finish before running the next step.

 

